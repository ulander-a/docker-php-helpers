#!/usr/bin/env bash
# docker-phpcs - Run PHPCS from project root vendor/bin
source /usr/local/bin/docker-common

MOUNT_SRC="$HOME/Code/src"
CONTAINER_ROOT="/var/www/src"

REPO_ROOT=$(find_repo_root)
if [ $? -ne 0 ]; then
  CURRENT_PWD=$(pwd)
  echo "ERROR: Could not find .gitlab-ci.yml in $CURRENT_PWD" >&2
  exit 1
fi

CONTAINER=$(detect_container "$REPO_ROOT")
if [ $? -ne 0 ]; then
  exit 1
fi

verify_container_running "$CONTAINER"
if [ $? -ne 0 ]; then
  exit 1
fi

TARGET_FILE="$1"

# If no args or first arg is a flag, pass everything through
if [ -z "$TARGET_FILE" ] || [[ "$TARGET_FILE" == -* ]]; then
  docker exec -it "$CONTAINER" "$CONTAINER_ROOT/vendor/bin/phpcs" "$@"
  exit 0
fi

shift

if [[ "$TARGET_FILE" != /* ]]; then
  TARGET_FILE="$REPO_ROOT/$TARGET_FILE"
fi

CONTAINER_PATH="$CONTAINER_ROOT${TARGET_FILE#$MOUNT_SRC}"

docker exec -it "$CONTAINER" "$CONTAINER_ROOT/vendor/bin/phpcs" "$CONTAINER_PATH" "$@"