#!/usr/bin/env bash
# docker-php - Run PHP in the container that matches .gitlab-ci.yml
source /usr/local/bin/docker-common

MOUNT_SRC="$HOME/Code/src"
CONTAINER_ROOT="/var/www/src"

REPO_ROOT=$(find_repo_root)
if [ $? -ne 0 ]; then
  echo "ERROR: Could not find .gitlab-ci.yml in any parent directory" >&2
  exit 1
fi

CONTAINER=$(detect_container "$REPO_ROOT")
if [ $? -ne 0 ]; then
  exit 1
fi

verify_container_running "$CONTAINER"
if [ $? -ne 0 ]; then
  exit 1
fi

TARGET_FILE="$1"
shift

if [ -z "$TARGET_FILE" ]; then
  echo "ERROR: No target file specified" >&2
  exit 1
fi

if [[ "$TARGET_FILE" != /* ]]; then
  TARGET_FILE="$REPO_ROOT/$TARGET_FILE"
fi

CONTAINER_PATH="$CONTAINER_ROOT${TARGET_FILE#$MOUNT_SRC}"

docker exec -it "$CONTAINER" php "$CONTAINER_PATH" "$@"